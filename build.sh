#!/bin/bash

# Set these variables if the script is unable
# to find the latest NDK version.
CLANG_BIN_PATH=""
ANDROID_NDK_PATH=""

# The ARCH we're building for.
ARCH="armv7a"

# The device we're building for.
DEVICE="onyx"

find_paths() {
    ANDROID_NDK_PATH=$(echo $PATH | tr ':' '\n' | grep -oP ".*/android-ndk[^:]*" | sort -Vr | head -n1)
    CLANG_BIN_PATH=$(find $ANDROID_NDK_PATH -type f -name 'armv7a-linux-androideabi*-clang' | sort -Vr | head -n1)
}

setup() {
    # If both path variables are empty, try to find the latest NDK version.
    if [ -z "$CLANG_BIN_PATH" ] && [ -z "$ANDROID_NDK_PATH" ]; then
        echo -e "[!] \$ANDROID_NDK_PATH and \$CLANG_BIN_PATH are empty!"
        echo -e "[*] Trying to find the latest NDK version..."
        find_paths

        # If the variables are still empty, there's nothing we can do.
        if [ -z "$CLANG_BIN_PATH" ] && [ -z "$ANDROID_NDK_PATH" ]; then
            echo -e "[!] Failed to find the latest NDK version!"
            exit 1
        fi

        echo "[*] Found clang version: $(basename $CLANG_BIN_PATH)!"
    fi
}

build_target() {
    TARGET=$1
    SRC_DR=$2
    rm -rf "$TARGET" "$TARGET.log" 2>/dev/null
    $CLANG_BIN_PATH -DSHELL "$SRC_DR"/*.c -o "$TARGET" > "$TARGET.log" 2>&1
}

setup
build_target "$DEVICE" "src"

if [ -f "$DEVICE" ]; then
    echo "[+] Successfully built CVE-2022-38181 for $DEVICE!"
    exit 0
else
    echo "[-] Build failed, check $DEVICE.log for more information!"
    exit 1
fi
